version: '3.8'

services:
  # Apache NiFi for ETL
  nifi:
    image: apache/nifi:1.24.0
    container_name: nifi
    ports:
      - "8080:8080"  # NiFi UI
      - "8443:8443"  # NiFi HTTPS
    environment:
      - NIFI_WEB_HTTP_PORT=8080
      - NIFI_WEB_HTTPS_PORT=8443
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=adminadmin123
    volumes:
      - nifi_data:/opt/nifi/nifi-current/conf
      - nifi_logs:/opt/nifi/nifi-current/logs
      - nifi_flowfile:/opt/nifi/nifi-current/flowfile_repository
      - nifi_content:/opt/nifi/nifi-current/content_repository
      - nifi_provenance:/opt/nifi/nifi-current/provenance_repository
      - ./data/nifi_input:/opt/nifi/input:rw
      - ./data/nifi_processed:/opt/nifi/processed:rw
      - ./nifi_integration.py:/opt/nifi/scripts/nifi_integration.py:ro
    networks:
      - vector-graph-net
    restart: unless-stopped

  # Qdrant Vector Database (existing)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - vector-graph-net
    restart: unless-stopped

  # Neo4j Graph Database (existing)
  neo4j:
    image: neo4j:5.13
    container_name: neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - vector-graph-net
    restart: unless-stopped

  # Your API service
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: vector-graph-api
    ports:
      - "8000:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
      - LMDB_PATH=/app/data/lmdb_meta
    volumes:
      - ./data:/app/data
      - ./core:/app/core:ro
      - ./api_v2.py:/app/api_v2.py:ro
    depends_on:
      - qdrant
      - neo4j
    networks:
      - vector-graph-net
    restart: unless-stopped
    command: python api_v2.py

  # ETL Processor (watches NiFi output directory)
  etl-processor:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: etl-processor
    environment:
      - NIFI_OUTPUT_DIR=/app/data/nifi_processed
      - API_ENDPOINT=http://api:8000/api/v1/nodes
      - ENABLE_API_PUSH=true
      - PYTHONPATH=/app
    volumes:
      - ./data:/app/data
      - ./nifi_integration.py:/app/nifi_integration.py:ro
      - ./pipeline_ingest.py:/app/pipeline_ingest.py:ro
      - ./core:/app/core:ro
    depends_on:
      - api
      - nifi
    networks:
      - vector-graph-net
    restart: unless-stopped
    command: >
      sh -c "
        while true; do
          python /app/nifi_integration.py /app/data/nifi_processed --api;
          sleep 10;
        done
      "

volumes:
  nifi_data:
  nifi_logs:
  nifi_flowfile:
  nifi_content:
  nifi_provenance:
  qdrant_data:
  neo4j_data:
  neo4j_logs:

networks:
  vector-graph-net:
    driver: bridge